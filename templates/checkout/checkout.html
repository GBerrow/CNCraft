{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_title %}Secure Checkout - {% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/checkout/checkout.css' %}">
{% endblock %}

{% block page_header %}
    <!-- Page header spacer for fixed navbar -->
    <div class="page-header-spacer"></div>
{% endblock %}

{% block content %}
<div class="checkout-page-wrapper">
    <div class="container-fluid">
        <!-- Progress Indicator -->
        <div class="checkout-progress">
            <div class="container">
                <div class="progress-steps">
                    <div class="progress-step completed">
                        <div class="step-number">1</div>
                        <span class="step-label">Cart</span>
                    </div>
                    <div class="progress-line active"></div>
                    <div class="progress-step active">
                        <div class="step-number">2</div>
                        <span class="step-label">Checkout</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-number">3</div>
                        <span class="step-label">Complete</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Checkout Content -->
        <div class="container">
            <div class="checkout-header">
                <h1 class="checkout-title">
                    <i class="fas fa-lock"></i>
                    Secure Checkout
                </h1>
                <p class="checkout-subtitle">Your order details and payment information are encrypted and secure</p>
            </div>

            <div class="row checkout-content">
                <!-- Left Column: Checkout Form -->
                <div class="col-12 col-lg-7 checkout-form-column">
                    <form action="{% url 'checkout' %}" method="POST" id="payment-form" class="checkout-form">
                        {% csrf_token %}
                        
                        <!-- Contact Information Section -->
                        <div class="form-section" id="contact-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-user"></i>
                                    Contact Information
                                </h3>
                                <span class="section-badge">Required</span>
                            </div>
                            <div class="section-content">
                                <div class="form-group">
                                    {{ order_form.full_name|as_crispy_field }}
                                </div>
                                <div class="form-group">
                                    {{ order_form.email|as_crispy_field }}
                                </div>
                                {% if not user.is_authenticated %}
                                <div class="auth-options">
                                    <p class="auth-message">
                                        <i class="fas fa-info-circle"></i>
                                        Already have an account? 
                                        <a href="{% url 'account_login' %}?next={% url 'checkout' %}" class="auth-link">Sign in</a> 
                                        for faster checkout
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Shipping Information Section -->
                        <div class="form-section" id="shipping-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-shipping-fast"></i>
                                    Shipping Address
                                </h3>
                                <span class="section-badge">Required</span>
                            </div>
                            <div class="section-content">
                                <div class="form-row">
                                    <div class="col-12">
                                        {{ order_form.phone_number|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-12">
                                        {{ order_form.street_address1|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-12">
                                        {{ order_form.street_address2|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-md-6">
                                        {{ order_form.town_or_city|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ order_form.county|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-md-6">
                                        {{ order_form.postcode|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ order_form.country|as_crispy_field }}
                                    </div>
                                </div>
                                
                                <!-- Save Information Option -->
                                <div class="save-info-section">
                                    {% if user.is_authenticated %}
                                        <div class="custom-checkbox">
                                            <input type="checkbox" id="id-save-info" name="save-info" checked class="custom-checkbox-input">
                                            <label for="id-save-info" class="custom-checkbox-label">
                                                <i class="fas fa-check custom-checkbox-icon"></i>
                                                Save this shipping information to my profile for future orders
                                            </label>
                                        </div>
                                    {% else %}
                                        <div class="save-info-message">
                                            <i class="fas fa-user-plus"></i>
                                            <a href="{% url 'account_signup' %}?next={% url 'checkout' %}" class="auth-link">Create an account</a> 
                                            to save this information for faster future checkouts
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Payment Information Section -->
                        <div class="form-section" id="payment-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-credit-card"></i>
                                    Payment Information
                                </h3>
                                <span class="section-badge">Required</span>
                            </div>
                            <div class="section-content">
                                {% if stripe_public_key == 'pk_test_placeholder' %}
                                    <!-- Test Mode Notice -->
                                    <div class="test-mode-notice">
                                        <div class="alert alert-info">
                                            <i class="fas fa-flask"></i>
                                            <strong>Test Mode Active</strong>
                                            <p>You're currently in test mode. No real payments will be processed. Your order will be completed successfully for testing purposes.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Test Mode Payment Form -->
                                    <div class="payment-form-container">
                                        <div class="card-element-wrapper">
                                            <div class="payment-label">
                                                Test Card Information <span class="required-asterisk">*</span>
                                            </div>
                                            <div class="test-card-info">
                                                <p><strong>Test Card Number:</strong> 4242 4242 4242 4242</p>
                                                <p><strong>Expiry Date:</strong> Any future date (e.g., 12/25)</p>
                                                <p><strong>CVC:</strong> Any 3 digits (e.g., 123)</p>
                                                <p><strong>ZIP Code:</strong> Any 5 digits (e.g., 12345)</p>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Payment Method Tabs -->
                                    <div class="payment-methods">
                                        <div class="payment-method active" data-method="card">
                                            <i class="fas fa-credit-card"></i>
                                            Credit / Debit Card
                                        </div>
                                    </div>

                                    <!-- Stripe Card Element Container -->
                                    <div class="payment-form-container">
                                        <div class="card-element-wrapper">
                                            <div class="payment-label">
                                                Card Information <span class="required-asterisk">*</span>
                                            </div>
                                            <div id="card-element" class="stripe-element" role="textbox" aria-label="Card Information">
                                                <!-- Stripe Elements will create form elements here -->
                                            </div>
                                            <div id="card-errors" class="payment-errors" role="alert" aria-live="polite"></div>
                                        </div>

                                        <!-- Security Badges -->
                                        <div class="payment-security">
                                            <div class="security-badges">
                                                <div class="security-badge">
                                                    <i class="fas fa-shield-alt"></i>
                                                    <span>SSL Encrypted</span>
                                                </div>
                                                <div class="security-badge">
                                                    <i class="fab fa-cc-stripe"></i>
                                                    <span>Powered by Stripe</span>
                                                </div>
                                            </div>
                                            <div class="accepted-cards">
                                                <i class="fab fa-cc-visa"></i>
                                                <i class="fab fa-cc-mastercard"></i>
                                                <i class="fab fa-cc-amex"></i>
                                                <i class="fab fa-cc-discover"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hidden form field for Stripe -->
                                    <input type="hidden" value="{{ client_secret }}" name="client_secret">
                                {% endif %}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <a href="{% url 'view_cart' %}" class="btn btn-secondary btn-back">
                                <i class="fas fa-arrow-left"></i>
                                Return to Cart
                            </a>
                            <button type="submit" id="submit-button" class="btn btn-primary btn-complete-order">
                                <span class="btn-content">
                                    <i class="fas fa-lock"></i>
                                    Complete Order
                                </span>
                                <span class="btn-amount">${{ grand_total|floatformat:2 }}</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Mobile Spacer for Clear Section Separation -->
                <div class="d-block d-lg-none mobile-checkout-spacer"></div>
                
                <!-- Right Column: Order Summary -->
                <div class="col-12 col-lg-5 order-summary-column">
                    <aside class="order-summary sticky-summary">
                        <div class="summary-header">
                            <h3 class="summary-title">
                                <i class="fas fa-shopping-bag"></i>
                                Order Summary
                            </h3>
                            <span class="item-count">{{ product_count }} item{{ product_count|pluralize }}</span>
                        </div>

                        <div class="summary-content">
                            <!-- Order Items -->
                            <div class="order-items">
                                {% for item in cart_items %}
                                <div class="order-item">
                                    <div class="item-image">
                                        <a href="{% url 'product_detail' item.product.id %}" class="item-image-link">
                                            <img src="{% static item.product.get_main_image %}" alt="{{ item.product.name }}" class="product-thumbnail">
                                        </a>
                                        <span class="item-quantity">{{ item.quantity }}</span>
                                    </div>
                                    <div class="item-details">
                                        <h4 class="item-name">
                                            <a href="{% url 'product_detail' item.product.id %}" class="item-link">
                                                {{ item.product.name }}
                                            </a>
                                        </h4>
                                        {% if item.product.sku %}
                                        <p class="item-sku">SKU: {{ item.product.sku }}</p>
                                        {% endif %}
                                        <div class="item-pricing">
                                            <span class="item-price">${{ item.product.get_display_price }}</span>
                                            {% if item.quantity > 1 %}
                                            <span class="item-quantity-text">x {{ item.quantity }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="item-total">
                                        ${{ item.get_total|floatformat:2 }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Order Totals -->
                            <div class="order-totals">
                                <div class="total-line">
                                    <span class="total-label">Subtotal</span>
                                    <span class="total-value">${{ total|floatformat:2 }}</span>
                                </div>
                                <div class="total-line">
                                    <span class="total-label">Shipping</span>
                                    <span class="total-value">
                                        {% if delivery == 0 %}
                                            <span class="free-shipping">FREE</span>
                                        {% else %}
                                            ${{ delivery|floatformat:2 }}
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="total-line total-line-grand">
                                    <span class="total-label">Total</span>
                                    <span class="total-value grand-total">${{ grand_total|floatformat:2 }}</span>
                                </div>
                            </div>

                            <!-- Trust Indicators -->
                            <div class="trust-indicators">
                                <div class="trust-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Secure 256-bit SSL encryption</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-undo"></i>
                                    <span>30-day return policy</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-truck"></i>
                                    <span>Free shipping on orders over $100</span>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-content">
            <i class="fas fa-sync-alt fa-spin"></i>
            <h3>Processing your order...</h3>
            <p>Please do not refresh or close this page</p>
            <!-- Emergency Reset Button -->
            <button type="button" id="emergency-reset-btn" class="btn btn-danger" style="margin-top: 20px; display: none;">
                <i class="fas fa-times"></i> Cancel Processing
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    {{ stripe_public_key|json_script:"id_stripe_public_key" }}
    <script src="https://js.stripe.com/v3/"></script>
    <script src="{% static 'javascript/checkout/checkout.js' %}"></script>
    <script>
        // Get Stripe public key from Django template
        const stripePublicKey = document.getElementById('id_stripe_public_key').textContent;
        
        // Emergency reset functionality
        document.addEventListener('DOMContentLoaded', function() {
            const emergencyBtn = document.getElementById('emergency-reset-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            if (emergencyBtn && loadingOverlay) {
                // Show emergency button after 3 seconds if loading overlay is visible
                setTimeout(() => {
                    if (loadingOverlay.style.display === 'flex' || loadingOverlay.classList.contains('show')) {
                        emergencyBtn.style.display = 'inline-block';
                    }
                }, 3000);
                
                // Handle emergency reset
                emergencyBtn.addEventListener('click', function() {
                    // Clear loading state
                    loadingOverlay.style.display = 'none';
                    loadingOverlay.classList.remove('show');
                    
                    // Re-enable submit button
                    const submitButton = document.querySelector('#submit-button');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<span class="btn-content"><i class="fas fa-lock"></i> Complete Order</span>';
                    }
                    
                    // Reset form to clear browser warnings
                    const form = document.getElementById('payment-form');
                    if (form) {
                        form.reset();
                    }
                    
                    // Remove beforeunload listeners
                    window.removeEventListener('beforeunload', function() {});
                    
                    console.log('Emergency reset completed');
                });
            }
        });
    </script>
{% endblock %}
