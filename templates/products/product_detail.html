{% extends "base.html" %} 
{% load static %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products/product_detail.css' %}" />
{% endblock %} 

{% block content %}
<div class="container py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'products' %}">Shop</a></li>
      <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="row product-detail-container">
    <!-- Product Image Section -->
    <div class="col-lg-6 mb-4">
      <div class="product-image-container">
        <!-- Main Product Image -->
        <div class="main-image-container mb-3">
          <img
            src="{% static product.get_main_image %}"
            alt="{{ product.name }}"
            class="product-main-image img-fluid"
            id="main-product-image"
          />
        </div>
        
        <!-- Product Image Gallery -->
        {% if product.get_product_images|length > 1 %}
        <div class="product-gallery">
          <h6 class="gallery-title mb-2">Product Images</h6>
          <div class="gallery-thumbnails">
            {% for image_path in product.get_product_images %}
            <div class="gallery-thumbnail" onclick="changeMainImage('{% static image_path %}', '{{ product.name }}')">
              <img 
                src="{% static image_path %}" 
                alt="{{ product.name }} - Image {{ forloop.counter }}"
                class="thumbnail-img"
                {% if forloop.first %}id="active-thumbnail"{% endif %}
              />
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Product Information Panel -->
    <div class="col-lg-6">
      <div class="product-info-panel">
        <!-- Product Header -->
        <div class="product-header mb-4">
          {% if product.category %}
          <p class="product-category text-muted mb-2">{{ product.category.friendly_name }}</p>
          {% endif %}
          <h1 class="product-title">{{ product.name }}</h1>
        </div>

        <!-- Pricing Section -->
        <div class="product-pricing mb-4">
          {% if product.discount_price %}
          <div class="price-container">
            <span class="current-price h2 text-success">${{ product.discount_price }}</span>
            <span class="original-price text-muted">${{ product.price }}</span>
            <span class="sale-badge ms-2">SALE</span>
          </div>
          {% else %}
          <span class="current-price h2 text-primary">${{ product.price }}</span>
          {% endif %}
        </div>

        <!-- Stock Status -->
        <div class="stock-status mb-4">
          {% if product.in_stock %}
          <span class="badge bg-success">✓ In Stock</span>
          {% else %}
          <span class="badge bg-danger">✗ Out of Stock</span>
          {% endif %}
        </div>

        <!-- Short Description -->
        {% if product.description %}
        <div class="product-description mb-4">
          <p>{{ product.description|truncatewords:25 }}</p>
        </div>
        {% endif %}

        <!-- Add to Cart Section -->
        {% if product.in_stock %}
        <div class="add-to-cart-section mb-5">
          <form action="{% url 'add_to_cart' product.id %}" method="POST">
            {% csrf_token %}
            <div class="quantity-row mb-3">
              <label for="quantity" class="form-label">Quantity:</label>
              <div class="quantity-controls">
                <input
                  type="number"
                  name="quantity"
                  id="quantity"
                  class="form-control quantity-input"
                  value="1"
                  min="1"
                  max="99"
                />
              </div>
            </div>
            <input type="hidden" name="redirect_url" value="{{ request.get_full_path }}" />
            <button type="submit" class="btn btn-primary btn-lg add-to-cart-btn">
              Add to Cart
            </button>
          </form>
        </div>
        {% endif %}

        <!-- Key Features List -->
        {% if product.dimensions or product.weight or product.material or product.power_requirement or product.working_area %}
        <div class="key-features mb-4">
          <h5 class="features-title">Key Features</h5>
          <ul class="features-list">
            {% if product.dimensions %}
            <li><strong>Dimensions:</strong> {{ product.dimensions }}</li>
            {% endif %}
            {% if product.weight %}
            <li><strong>Weight:</strong> {{ product.weight }} kg</li>
            {% endif %}
            {% if product.material %}
            <li><strong>Material:</strong> {{ product.material }}</li>
            {% endif %}
            {% if product.power_requirement %}
            <li><strong>Power:</strong> {{ product.power_requirement }}</li>
            {% endif %}
            {% if product.working_area %}
            <li><strong>Working Area:</strong> {{ product.working_area }}</li>
            {% endif %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Related Products Section -->
  <div class="related-products-section mt-5">
    <h4 class="section-title">You might also like</h4>
    {% if related_products %}
        <div class="row g-4">
            {% for related_product in related_products %}
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm product-card">
                    <div class="position-relative">
                        <img src="{% static related_product.get_main_image %}" alt="{{ related_product.name }}" 
                             class="card-img-top" style="height: 180px; object-fit: cover;">
                        
                        {% if related_product.discount_price %}
                            <span class="badge bg-danger position-absolute top-0 end-0 m-2">Sale</span>
                        {% endif %}
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ related_product.name|truncatechars:40 }}</h6>
                        <p class="card-text text-muted small flex-grow-1">
                            {{ related_product.description|truncatewords:12 }}
                        </p>
                        <div class="d-flex justify-content-between align-items-center mt-auto">
                            <div class="price">
                                {% if related_product.discount_price %}
                                    <span class="text-danger fw-bold">${{ related_product.discount_price }}</span>
                                    <small class="text-muted text-decoration-line-through ms-1">
                                        ${{ related_product.price }}
                                    </small>
                                {% else %}
                                    <span class="fw-bold">${{ related_product.price }}</span>
                                {% endif %}
                            </div>
                            <a href="{% url 'product_detail' related_product.id %}" class="btn btn-primary btn-sm">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-4">
            <p class="text-muted">No related products available at the moment.</p>
            <a href="{% url 'products' %}" class="btn btn-outline-primary">Browse All Products</a>
        </div>
    {% endif %}
</div>

  <!-- Back to Products -->
  <div class="navigation-section mt-4">
    <a href="{% url 'products' %}" class="btn btn-outline-secondary">
      ← Back to Shop
    </a>
  </div>
</div>

<script>
  // Product image gallery functionality
  function changeMainImage(imageSrc, productName) {
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.gallery-thumbnail');
    
    // Update main image
    mainImage.src = imageSrc;
    mainImage.alt = productName;
    
    // Update active thumbnail
    thumbnails.forEach(thumb => {
      const img = thumb.querySelector('img');
      if (img.src === imageSrc) {
        thumb.classList.add('active');
        img.id = 'active-thumbnail';
      } else {
        thumb.classList.remove('active');
        img.removeAttribute('id');
      }
    });
  }
  
  // Add click event listeners to thumbnails
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.gallery-thumbnail');
    thumbnails.forEach(thumb => {
      thumb.addEventListener('click', function() {
        const img = this.querySelector('img');
        changeMainImage(img.src, img.alt);
      });
    });
  });
</script>
{% endblock %}
